<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>QRConnect Chat</title>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/static/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/static/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/static/favicon-16x16.png"
    />
    <link rel="manifest" href="/static/site.webmanifest" />
    <style>
      :root {
        color-scheme: light dark;
        /* Base (midnight-like) defaults */
        --bg: #0f172a;
        --bg-alt: #020617;
        --bg-highlight: #1f2937;
        --fg: #e5e7eb;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.15);
        --border: #1e293b;
        --danger: #f97373;
        --message-bg: rgba(15, 23, 42, 0.85);
        --system-bg: rgba(56, 189, 248, 0.15);
        --system-border: rgba(56, 189, 248, 0.5);
        --outgoing-from: #0ea5e9;
        --outgoing-to: #22c55e;
        --app-bg: linear-gradient(145deg, #020617, #0f172a);
        --app-shadow: 0 18px 50px rgba(15, 23, 42, 0.85);
        --input-bg: rgba(15, 23, 42, 0.85);
        --input-border: rgba(148, 163, 184, 0.3);
        --input-placeholder: rgba(148, 163, 184, 0.7);
        --button-bg: radial-gradient(circle at top left, #0ea5e9, #22c55e);
        --button-text: #0b1120;
        --button-shadow: 0 8px 20px rgba(34, 197, 94, 0.35);
      }

      /* Themes */
      body.theme-midnight {
        --bg: #020617;
        --bg-alt: #020617;
        --bg-highlight: #1f2937;
        --fg: #e5e7eb;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.15);
        --border: #1e293b;
        --danger: #f97373;
        --message-bg: rgba(15, 23, 42, 0.9);
        --system-bg: rgba(56, 189, 248, 0.18);
        --system-border: rgba(56, 189, 248, 0.6);
        --outgoing-from: #0ea5e9;
        --outgoing-to: #22c55e;
        --app-bg: linear-gradient(145deg, #020617, #020617);
        --app-shadow: 0 22px 60px rgba(15, 23, 42, 0.95);
        --input-bg: rgba(15, 23, 42, 0.9);
        --input-border: rgba(148, 163, 184, 0.4);
        --input-placeholder: rgba(148, 163, 184, 0.8);
        --button-bg: radial-gradient(circle at top left, #0ea5e9, #22c55e);
        --button-text: #020617;
        --button-shadow: 0 10px 26px rgba(34, 197, 94, 0.45);
      }

      body.theme-love {
        --bg: #1b0629;
        --bg-alt: #120018;
        --bg-highlight: #4c1d95;
        --fg: #fee2e2;
        --accent: #fb7185;
        --accent-soft: rgba(251, 113, 133, 0.18);
        --border: #4c0519;
        --danger: #f97373;
        --message-bg: rgba(88, 28, 135, 0.9);
        --system-bg: rgba(251, 113, 133, 0.25);
        --system-border: rgba(251, 113, 133, 0.75);
        --outgoing-from: #ec4899;
        --outgoing-to: #f97316;
        --app-bg: linear-gradient(145deg, #120018, #4c1d95);
        --app-shadow: 0 22px 60px rgba(76, 5, 25, 0.85);
        --input-bg: rgba(76, 5, 89, 0.9);
        --input-border: rgba(251, 113, 133, 0.6);
        --input-placeholder: rgba(254, 202, 202, 0.8);
        --button-bg: radial-gradient(circle at top left, #ec4899, #f97316);
        --button-text: #130016;
        --button-shadow: 0 10px 26px rgba(236, 72, 153, 0.6);
      }

      body.theme-terminal {
        --bg: #000000;
        --bg-alt: #00130a;
        --bg-highlight: #000000;
        --fg: #bbf7d0;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.12);
        --border: #065f46;
        --danger: #f97373;
        --message-bg: rgba(0, 0, 0, 0.95);
        --system-bg: rgba(34, 197, 94, 0.25);
        --system-border: rgba(34, 197, 94, 0.85);
        --outgoing-from: #16a34a;
        --outgoing-to: #4ade80;
        --app-bg: linear-gradient(145deg, #000000, #00130a);
        --app-shadow: 0 22px 60px rgba(0, 0, 0, 0.9);
        --input-bg: rgba(0, 0, 0, 0.9);
        --input-border: rgba(16, 185, 129, 0.8);
        --input-placeholder: rgba(52, 211, 153, 0.9);
        --button-bg: linear-gradient(135deg, #16a34a, #22c55e);
        --button-text: #01110a;
        --button-shadow: 0 10px 26px rgba(16, 185, 129, 0.7);
      }

      body.theme-minimal {
        --bg: #f3f4f6;
        --bg-alt: #f9fafb;
        --bg-highlight: #f3f4f6;
        --fg: #111827;
        --accent: #4b5563;
        --accent-soft: rgba(75, 85, 99, 0.12);
        --border: #e5e7eb;
        --danger: #b91c1c;
        --message-bg: rgba(255, 255, 255, 0.98);
        --system-bg: rgba(229, 231, 235, 0.95);
        --system-border: rgba(148, 163, 184, 0.9);
        --outgoing-from: #d1d5db;
        --outgoing-to: #f9fafb;
        --app-bg: linear-gradient(145deg, #ffffff, #e5e7eb);
        --app-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
        --input-bg: #ffffff;
        --input-border: rgba(156, 163, 175, 0.7);
        --input-placeholder: rgba(156, 163, 175, 0.85);
        --button-bg: linear-gradient(135deg, #e5e7eb, #ffffff);
        --button-text: #111827;
        --button-shadow: 0 8px 22px rgba(156, 163, 175, 0.6);
      }

      body.theme-minimal-dark {
        --bg: #080808;
        --bg-alt: #080808;
        --bg-highlight: #111111;
        --fg: #e5e7eb;
        --accent: #9ca3af;
        --accent-soft: rgba(156, 163, 175, 0.18);
        --border: #111827;
        --danger: #f97373;
        --message-bg: #050505;
        --system-bg: #101010;
        --system-border: rgba(75, 85, 99, 0.85);
        --outgoing-from: #2f2f2f;
        --outgoing-to: #050505;
        --app-bg: linear-gradient(145deg, #050505, #050505);
        --app-shadow: 0 24px 70px rgba(0, 0, 0, 1);
        --input-bg: #101010;
        --input-border: rgba(75, 85, 99, 0.9);
        --input-placeholder: rgba(156, 163, 175, 0.9);
        --button-bg: linear-gradient(135deg, #2f2f2f, #101010);
        --button-text: #e5e7eb;
        --button-shadow: 0 12px 32px rgba(15, 23, 42, 0.9);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, var(--bg-highlight), var(--bg-alt));
        color: var(--fg);
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .app {
        margin: 12px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--app-bg);
        box-shadow: var(--app-shadow);
        width: 100%;
        max-width: 600px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .title {
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pill {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        opacity: 0.85;
      }

      .status {
        font-size: 0.78rem;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--danger);
        box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.25);
      }

      .status-dot.status-dot--connected {
        background: #22c55e;
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
      }

      .status-text {
        opacity: 0.8;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
      }

      .messages {
        flex: 1;
        padding: 12px 16px 8px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        gap: 6px;
        font-size: 0.9rem;
      }

      .message {
        padding: 6px 10px;
        border-radius: 10px;
        background: var(--message-bg);
        border: 1px solid rgba(148, 163, 184, 0.25);
        align-self: flex-start;
        max-width: 80%;
        display: inline-block;
        word-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
      }

      .message--system {
        background: var(--system-bg);
        border-color: var(--system-border);
        font-size: 0.8rem;
        opacity: 0.85;
      }

      .message--outgoing {
        align-self: flex-end;
        background: linear-gradient(135deg, var(--outgoing-from), var(--outgoing-to));
        border-color: transparent;
        color: #0b1120;
      }

      .message-meta {
        display: block;
        font-size: 0.7rem;
        opacity: 0.7;
        margin-bottom: 2px;
      }

      .footer {
        padding: 10px 12px 12px;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .input-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .input-row input[type="text"] {
        flex: 1;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--fg);
        font-size: 0.9rem;
        outline: none;
        min-width: 0;
      }

      .input-row input[type="text"]::placeholder {
        color: var(--input-placeholder);
      }

      .input-row button {
        border-radius: 999px;
        border: none;
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        background: var(--button-bg);
        color: var(--button-text);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: var(--button-shadow);
      }

      .input-row button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .hint {
        font-size: 0.72rem;
        opacity: 0.7;
        display: flex;
        justify-content: space-between;
      }

      .hint span {
        white-space: nowrap;
      }

      .settings {
        position: relative;
      }

      .settings-button {
        border-radius: 999px;
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.45);
        color: inherit;
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0;
        font-size: 0.9rem;
      }

      .settings-button:hover {
        background: rgba(148, 163, 184, 0.12);
      }

      .settings-menu {
        position: absolute;
        top: 110%;
        right: 0;
        background: var(--bg-alt);
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 14px 40px rgba(15, 23, 42, 0.85);
        min-width: 150px;
        padding: 6px;
        display: none;
        z-index: 20;
      }

      .settings-menu.settings-menu--open {
        display: block;
      }

      .settings-menu-title {
        font-size: 0.72rem;
        opacity: 0.7;
        padding: 4px 6px 6px;
      }

      .settings-menu button {
        width: 100%;
        border: none;
        background: transparent;
        color: inherit;
        text-align: left;
        font-size: 0.8rem;
        padding: 6px 8px;
        border-radius: 8px;
        cursor: pointer;
      }

      .settings-menu button:hover {
        background: rgba(148, 163, 184, 0.16);
      }

      .settings-menu button.is-active {
        background: rgba(148, 163, 184, 0.24);
      }

      @media (max-width: 480px) {
        .app {
          margin: 0;
          border-radius: 0;
          max-width: none;
        }

        .header,
        .footer {
          padding-left: 10px;
          padding-right: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <div class="title">
          <span>QRConnect</span>
          <span class="pill">LAN chat</span>
        </div>
        <div class="header-right">
          <div class="status" id="status">
            <span class="status-dot" id="statusDot"></span>
            <span class="status-text" id="statusText">Connecting…</span>
          </div>
          <div class="settings">
            <button
              id="settingsButton"
              class="settings-button"
              type="button"
              aria-label="Chat settings"
            >
              &#9881;
            </button>
            <div class="settings-menu" id="settingsMenu">
              <div class="settings-menu-title">Theme</div>
              <button type="button" data-theme="midnight" class="is-active">
                Midnight
              </button>
              <button type="button" data-theme="love">Love</button>
              <button type="button" data-theme="terminal">Terminal</button>
              <button type="button" data-theme="minimal">Minimal light</button>
              <button type="button" data-theme="minimal-dark">
                Minimal dark
              </button>
            </div>
          </div>
        </div>
      </header>
      <main class="messages" id="messages" aria-live="polite"></main>
      <footer class="footer">
        <div class="input-row">
          <input
            id="messageInput"
            type="text"
            autocomplete="off"
            placeholder="Type a message"
          />
          <button id="sendButton" type="button">
            <span>Send</span>
          </button>
        </div>
        <div class="hint">
          <span>Press Enter to send</span>
          <span>Messages are shared with all devices</span>
        </div>
      </footer>
    </div>

    <script>
      (function () {
        const messagesEl = document.getElementById("messages");
        const inputEl = document.getElementById("messageInput");
        const sendButtonEl = document.getElementById("sendButton");
        const statusDotEl = document.getElementById("statusDot");
        const statusTextEl = document.getElementById("statusText");
        const settingsButtonEl = document.getElementById("settingsButton");
        const settingsMenuEl = document.getElementById("settingsMenu");

        let socket = null;
        let isConnected = false;
        // Track messages we just sent so we can style their echo as outgoing.
        const pendingOutgoing = [];
        let currentTheme = "midnight";

        function setStatus(connected, text) {
          isConnected = connected;
          if (connected) {
            statusDotEl.classList.add("status-dot--connected");
            statusTextEl.textContent = text || "Connected";
            sendButtonEl.disabled = false;
          } else {
            statusDotEl.classList.remove("status-dot--connected");
            statusTextEl.textContent = text || "Disconnected";
            sendButtonEl.disabled = true;
          }
        }

        function scrollToBottom() {
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addMessage(text, options) {
          const opts = options || {};
          const el = document.createElement("div");
          el.classList.add("message");
          if (opts.system) {
            el.classList.add("message--system");
          }
          if (opts.outgoing) {
            el.classList.add("message--outgoing");
          }
          el.textContent = text;
          messagesEl.appendChild(el);
          scrollToBottom();
        }

        function connect() {
          const protocol =
            window.location.protocol === "https:" ? "wss" : "ws";
          const wsUrl = protocol + "://" + window.location.host + "/ws";

          try {
            socket = new WebSocket(wsUrl);
          } catch (e) {
            console.error("Failed to create WebSocket:", e);
            addMessage("[system] Could not create WebSocket connection.", {
              system: true,
            });
            setStatus(false, "Error");
            return;
          }

          setStatus(false, "Connecting…");

          socket.addEventListener("open", () => {
            setStatus(true, "Connected");
            addMessage("[system] Connected to QRConnect.", { system: true });
          });

          socket.addEventListener("message", (event) => {
            const text = String(event.data || "");

            // If this matches a message we just sent, treat it as outgoing.
            let isOutgoing = false;
            if (pendingOutgoing.length > 0 && pendingOutgoing[0] === text) {
              pendingOutgoing.shift();
              isOutgoing = true;
            }

            addMessage(text, { outgoing: isOutgoing });
          });

          socket.addEventListener("close", () => {
            setStatus(false, "Disconnected");
            addMessage("[system] Disconnected from server.", { system: true });
          });

          socket.addEventListener("error", (event) => {
            console.error("WebSocket error:", event);
            setStatus(false, "Error");
            addMessage("[system] WebSocket error.", { system: true });
          });
        }

        function sendCurrentMessage() {
          const text = inputEl.value.trim();
          if (!text || !socket || socket.readyState !== WebSocket.OPEN) {
            return;
          }
          // Remember this text so we can style the echoed message as outgoing.
          pendingOutgoing.push(text);
          socket.send(text);
          inputEl.value = "";
          inputEl.focus();
        }

        function applyTheme(theme) {
          currentTheme = theme;
          document.body.classList.remove(
            "theme-midnight",
            "theme-love",
            "theme-terminal",
            "theme-minimal",
            "theme-minimal-dark"
          );
          document.body.classList.add(`theme-${theme}`);
          try {
            window.localStorage.setItem("qrconnect-theme", theme);
          } catch (_) {
            // ignore
          }

          const buttons = settingsMenuEl.querySelectorAll("button[data-theme]");
          buttons.forEach((btn) => {
            if (btn.getAttribute("data-theme") === theme) {
              btn.classList.add("is-active");
            } else {
              btn.classList.remove("is-active");
            }
          });
        }

        function toggleSettingsMenu() {
          settingsMenuEl.classList.toggle("settings-menu--open");
        }

        function closeSettingsMenu() {
          settingsMenuEl.classList.remove("settings-menu--open");
        }

        sendButtonEl.addEventListener("click", sendCurrentMessage);

        inputEl.addEventListener("keydown", (event) => {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendCurrentMessage();
          }
        });

        window.addEventListener("load", () => {
          // Theme
          let storedTheme = null;
          try {
            storedTheme = window.localStorage.getItem("qrconnect-theme");
          } catch (_) {
            storedTheme = null;
          }
          applyTheme(storedTheme || "midnight");

          connect();
          inputEl.focus();
        });

        settingsButtonEl.addEventListener("click", (event) => {
          event.stopPropagation();
          toggleSettingsMenu();
        });

        settingsMenuEl.addEventListener("click", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const theme = target.getAttribute("data-theme");
          if (!theme) return;
          applyTheme(theme);
          closeSettingsMenu();
        });

        document.addEventListener("click", (event) => {
          if (!settingsMenuEl.classList.contains("settings-menu--open")) {
            return;
          }
          if (
            !settingsMenuEl.contains(event.target) &&
            event.target !== settingsButtonEl
          ) {
            closeSettingsMenu();
          }
        });
      })();
    </script>
  </body>
  </html>
